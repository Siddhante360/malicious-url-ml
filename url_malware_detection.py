# -*- coding: utf-8 -*-
"""URL_Malware_Detection.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1qYGumUtfhVmqv-WjMGbf6KitCWsAljXf
"""

from google.colab import drive
drive.mount('/content/drive')

!ls /content/drive/MyDrive

import pandas as pd

df = pd.read_csv("/content/drive/MyDrive/urls_dataset_5000_balanced.csv")
df.head()

df.head()
df.shape
df["label"].value_counts()

import re
from urllib.parse import urlparse

def extract_url_features(url):
    parsed = urlparse(url)
    return {
        "url_length": len(url),
        "num_dots": url.count("."),
        "num_slashes": url.count("/"),
        "num_digits": sum(c.isdigit() for c in url),
        "has_ip": 1 if re.search(r"\d+\.\d+\.\d+\.\d+", url) else 0,
        "has_https": 1 if parsed.scheme == "https" else 0,
        "has_at": 1 if "@" in url else 0,
        "has_exe": 1 if ".exe" in url.lower() else 0,
        "has_zip": 1 if ".zip" in url.lower() else 0,
        "num_special_chars": sum(url.count(c) for c in "-_?=&%")
    }

import pandas as pd

rows = []
for _, r in df.iterrows():
    f = extract_url_features(r["url"])
    f["label"] = r["label"]
    rows.append(f)

features_df = pd.DataFrame(rows)
features_df.head()

features_df.info()

from sklearn.model_selection import train_test_split

X = features_df.drop("label", axis=1)
y = features_df["label"]

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, shuffle=True
)

from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()
X_train_s = scaler.fit_transform(X_train)
X_test_s = scaler.transform(X_test)

from tqdm import tqdm
from sklearn.ensemble import RandomForestClassifier

n_trees = 200
batch_size = 10   # number of trees added per iteration

model = RandomForestClassifier(
    n_estimators=0,          # start with 0 trees
    warm_start=True,         # VERY IMPORTANT
    random_state=42,
    n_jobs=-1
)

for i in tqdm(range(0, n_trees, batch_size), desc="Training Random Forest"):
    model.n_estimators += batch_size
    model.fit(X_train_s, y_train)

len(model.estimators_)

from sklearn.metrics import accuracy_score, confusion_matrix, classification_report

y_pred = model.predict(X_test_s)

print("Accuracy:", accuracy_score(y_test, y_pred))
print("\nConfusion Matrix:\n", confusion_matrix(y_test, y_pred))
print("\nClassification Report:\n", classification_report(y_test, y_pred))

import joblib

joblib.dump(model, "/content/drive/MyDrive/url_malware_rf_model.pkl")
joblib.dump(scaler, "/content/drive/MyDrive/url_scaler.pkl")

test_urls = [
    "https://www.google.com",
    "http://secure-update123.site/update.exe"
]

for url in test_urls:
    feats = extract_url_features(url)
    feats_df = pd.DataFrame([feats])
    feats_scaled = scaler.transform(feats_df)
    pred = model.predict(feats_scaled)[0]
    print(url, "â†’", "Malicious" if pred == 1 else "Benign")

